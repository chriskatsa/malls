<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us">
<head>

<title>50 Largest US Shopping Malls</title>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=7, IE=9">

<link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.2/js/esri/css/esri.css" />
<link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.2/js/dojo/dijit/themes/claro/claro.css">
<link rel="stylesheet" type="text/css" href="css/style.css">

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

<script type="text/javascript">var djConfig = {parseOnLoad: true};</script>
<script type="text/javascript" src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=3.2"></script>
<script type="text/javascript" src="http://storymaps.esri.com/common/helper_functions.js"></script>
<script type="text/javascript" src="lib/ie8_compatibility.js"></script>
<script type="text/javascript" src="lib/LocationsService.js"></script>


<!--Social Media Links-->
<script type="text/javascript">var switchTo5x=true;</script>
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher:'77225c91-2742-42f7-b1b4-bddda99a9bde'});</script>
<!--END Social Media Links-->

<!--Google Analytics Start-->
<script type="text/javascript">
  if (window.location.href.toLowerCase().indexOf("storymaps.esri.com") >= 0) {
	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-26529417-1']);
	  _gaq.push(['_trackPageview']);
	
	  (function() {
		 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();
  }
</script>
<!--Google Analytics End-->

<script type="text/javascript">

dojo.require("dijit.layout.BorderContainer");
dojo.require("dijit.layout.ContentPane");
dojo.require("esri.arcgis.utils");
dojo.require("esri.map");

/******************************************************
***************** begin config section ****************
*******************************************************/

var TITLE = "Fifty Largest Shopping Malls in the United States"
var BYLINE = "Nam convallis mauris sem. Vestibulum facilisis, sapien et tristique laoreet, justo ligula accumsan massa, in iaculis justo dui eu sem. Maecenas ac lectus nisl."
var BASEMAP_URL = "http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer";
var SATELLITE_URL = "http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"
var CSV_FILE = "data/Top50Malls_2012.csv";
var MALL_ZOOM_LEVEL = 15;

/******************************************************
***************** end config section ******************
*******************************************************/


var _dojoReady = false;
var _jqueryReady = false;

var _map;
var _initExtent;
var _map2;

var _locations;

var _isMobile = isMobile();

var _selected;

dojo.addOnLoad(function() {_dojoReady = true;init()});
jQuery(document).ready(function() {_jqueryReady = true;init()});

function init() {
	
	if (!_jqueryReady) return;
	if (!_dojoReady) return;
	
	$("#title").append(TITLE);
	$("#subtitle").append(BYLINE);	

	handleWindowResize();
	$(this).resize(handleWindowResize);
		
	_extent = new esri.geometry.Extent({"xmin":-18775379.213364024,"ymin":2905829.385274,"xmax":-3121075.82056398,"ymax":6467183.407136008,"spatialReference":{"wkid":102100}});

	var locationsService = new LocationsService();		  
	$(locationsService).bind("complete", function(){
		_locations = locationsService.getLocations();
		_selected = _locations[0];
		populateFacts();
		init2();
	});
	locationsService.process(CSV_FILE);		
	
	_map = new esri.Map("map",{slider:false,wrapAround180:true});
	_map.addLayer(new esri.layers.ArcGISTiledMapServiceLayer(SATELLITE_URL));
	dojo.connect(_map, 'onLoad', init2);

	_map2 = new esri.Map("map2",{slider:false,wrapAround180:true,logo:false});
	_map2.addLayer(new esri.layers.ArcGISTiledMapServiceLayer(BASEMAP_URL));	
	dojo.connect(_map2, 'onLoad', init2);
	
}

function init2(map) {

	if (!_map.loaded) return;
	if (!_map2.loaded) return;
	if (!_locations) return;
	
	_map.graphics.hide();
	$(_locations).each(function(index, element) {
	   _map.graphics.add(element); 
	});	
	
	dojo.connect(_map.graphics, "onMouseOver", layer_onMouseOver);
	dojo.connect(_map.graphics, "onMouseOut", layer_onMouseOut);
	dojo.connect(_map.graphics, "onClick", layer_onClick);
	
	setTimeout(situateMaps,500);
	setTimeout(function(){_map.graphics.show()},1000);
	
	$("#zoomIn").click(function(e) {
		_map.setLevel(_map.getLevel()+1);
	});
	$("#zoomOut").click(function(e) {
		_map.setLevel(_map.getLevel()-1);
	});
	$("#zoomExtent").click(function(e) {
		_map.setExtent(_extent);
	});

	$(".arrow").click(onArrowClick)

}

function handleWindowResize() {
	var heightDoc = getViewportDimensions()[1];
	$("#mainWindow").height(heightDoc - ($("#header").height() + $("#bottom").height()));
	dijit.byId("mainWindow").layout();
	$("#map").height($("#mainWindow").height());
	$("#map2").height($("#mainWindow").height()-$("#divTable").height());
	if (_map) _map.resize();
	if (_map2) _map2.resize();
	if (_selected) {
		setTimeout(function(){	
		_map.centerAt(_selected.geometry);
		_map2.centerAt(_selected.geometry);
		},500);
	}
}

function layer_onClick(event)
{
	_selected = event.graphic;
	//var index = $.inArray(_selected,_locations);
	postSelection();
}

function layer_onMouseOver(event)
{
	if (_isMobile) return;	
	_map.setMapCursor("pointer");
	/*
	var graphic = event.graphic;
	graphic.setSymbol(graphic.symbol.setHeight(30).setWidth(24));
	$("#hoverInfo").html(graphic.attributes.name);
	var pt = _map.toScreen(graphic.geometry);
	hoverInfoPos(pt.x,pt.y);	
	*/
}

function layer_onMouseOut(event)
{
	_map.setMapCursor("default");
	/*
	var graphic = event.graphic;	
	graphic.setSymbol(graphic.symbol.setHeight(28).setWidth(22));
	$("#hoverInfo").hide();	
	*/
}

function postSelection() {
	populateFacts();
	situateMaps();
}

function populateFacts() {
	$("#cellName").empty();
	$("#cellName").append(_selected.attributes.name);
	$("#cellDescription").empty();
	$("#cellDescription").append(_selected.attributes.description);
	$("#divRank").empty();
	$("#divRank").append(_selected.attributes.rank);
}

function situateMaps() {
	_map2.graphics.clear();
	_map2.graphics.add(new esri.Graphic(_selected.geometry,new esri.symbol.PictureMarkerSymbol("images/purple.png",22,22)));
	_map.centerAndZoom(_selected.geometry,MALL_ZOOM_LEVEL);
	_map2.centerAndZoom(_selected.geometry,2);
}

function onArrowClick(event) {
	var index = $.inArray(_selected,_locations);
	if (event.target.id == "arrowRight") {
		if (index == _locations.length) index = 0;
		else index++
	} else {
		if (index == 0) index = _locations.length;
		else index--;
	}
	_selected = _locations[index];
	postSelection();
}

</script>

</head>

<body class="claro">
    
    <!-- Header Section-->
    <div id="header">
      <div id="headerText">
	    <h1 id="title"></h1>
	    <h2 id="subtitle"></h2>
      </div>
      <div id="logoArea">
        <div id="social"><a id="msLink" href="http://mapstories.esri.com" target="_blank">A story map </a><span  class='st_facebook' ></span><span  class='st_twitter' ></span>
        </div>
        <div id="logo"><a id="logoLink" href="http://www.esri.com" target="_blank"><img id="logoImg" src="images/esriGlobeLogow.png" alt="Esri - Home"></a></div>
      </div>
    </div>
    
      <!--Content-->
      <div id="mainWindow" dojotype="dijit.layout.BorderContainer" gutters="false" region="center" style="width:100%;height:100%">
      
      	<!--Sidebar Section-->
        <div dojotype="dijit.layout.ContentPane" id="leftPane" region="left">
          	<div id="map2"></div>
            <div id="divTable">
                <table id="tableDetails">
                    <tr>
                        <td class="columnTitle">Mall</td>
                        <td id="cellName" class="columnData purple" height="20px"></td>
                        <td class="columnBlank"></td>
                    </tr>
                    <tr>
                        <td class="columnTitle">Factoid</td>
                        <td id="cellDescription" class="columnData" height="85px"></td>
                        <td class="columnBlank"></td>
                    </tr>
                    <tr>
                        <td class="columnTitle">Rank</td>
                        <td id="cellRank" class="columnData purple" height="40px" style="font-size:60px">
 	                        <img id='arrowLeft' class='arrow' src='images/picture_left.png'</img>
                            <div id="divRank"></div>
                            <img id='arrowRight' class='arrow' src='images/picture_right.png'</img>
                        </td>
                        <td class="columnBlank"></td>
                    </tr>
                    <tr>
                        <td class="columnTitle">Where</td>
                        <td class="columnData"></td>
                        <td class="columnBlank"></td>
                    </tr>
                    <tr>
                        <td class="columnTitle">Size</td>
                        <td class="columnData"></td>
                        <td class="columnBlank"></td>
                    </tr>
                    <tr>
                        <td class="columnTitle">Opened</td>
                        <td class="columnData"></td>
                        <td class="columnBlank"></td>
                    </tr>
                    <tr>
                        <td class="columnTitle">Levels</td>
                        <td class="columnData"></td>
                        <td class="columnBlank"></td>
                    </tr>
                    <tr>
                        <td class="columnTitle">Website</td>
                        <td class="columnData"></td>
                        <td class="columnBlank"></td>
                    </tr>
                </table>
        	</div>
        </div><!--/leftPane-->
        
        <!--Map Section-->
        <div dojotype="dijit.layout.ContentPane" id="map" region="center">
            <div id="zoomToggle">
                <img id="zoomIn" src="images/ZoomLight_01.png">
                <img id="zoomExtent" src="images/ZoomHome.png">
                <img id="zoomOut" src="images/ZoomLight_03.png">
            </div><!--?zoomToggle-->
        </div><!--mapPane-->
            
      </div><!--/content-->    
      
      <div id="bottom">
      	<table style="width:100%;height:100%">
        	<tr>
            	<td style="text-align:center;vertical-align:middle">Graph will go here.</td>
            </tr>
        </table>
      </div>

        
</body>

</html>